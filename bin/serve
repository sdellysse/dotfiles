#!/usr/bin/env node

var fs = require("fs");
var http = require("http");
var path = require("path");
var url = require("url");

var port, root, writeResponse;
port = parseInt((process.argv[2] || 80), 10);
root = process.cwd();
writeResponse = function (response, text, code, headers) {
    response.writeHead(code || 200, headers || {});
    response.write(text);
    response.end();
};

http.createServer(function (request, response) {
    var filename;

    console.log(request.method.toUpperCase()+" "+request.url);

    filename = path.join(root, url.parse(request.url).pathname);
    fs.exists(filename, function (exists) {
        if (!exists) {
            return writeResponse(response, "404", 404, {
                "Content-Type": "text/plain"
            });
        }

        fs.stat(filename, function (err, stats) {
            if (stats.isDirectory()) {
                filename = filename+"/index.html";
            }

            fs.readFile(filename, "binary", function (err, contents) {
                if (err) {
                    return writeResponse(response, err, 500, {
                        "Content-Type": "text/plain"
                    });
                }
                response.writeHead(200);
                response.write(contents, "binary");
                response.end();
            });
        });
    });
}).listen(port);

console.log("HTTP server on http://localhost:"+port);
console.log("C-c to shutdown");
